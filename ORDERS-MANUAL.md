# 订单管理功能使用说明

## 功能概述

本电商平台现在具备完整的订单管理功能，用户可以：

- ✅ 创建订单（下单）
- ✅ 查看订单列表和详情
- ✅ 订单支付（余额支付）
- ✅ 订单取消（待支付状态）
- ✅ 查看物流信息
- ✅ 确认收货
- ✅ 再次购买订单商品
- ✅ 订单状态管理

## 技术实现

### 后端实现

1. **数据模型** (`models/Order.js`)
   - 完整的订单信息：订单号、用户、商品、金额、状态等
   - 收货地址信息
   - 支付信息（支付方式、支付时间、交易号）
   - 物流信息（物流公司、运单号、发货时间、签收时间）
   - 订单备注和状态变更时间戳

2. **API端点** (`server.js`)
   - `GET /api/orders` - 获取用户订单列表
   - `GET /api/orders/:id` - 获取单个订单详情
   - `POST /api/orders` - 创建新订单
   - `POST /api/orders/:id/pay` - 支付订单
   - `POST /api/orders/:id/cancel` - 取消订单
   - `POST /api/orders/:id/ship` - 发货（管理员功能）
   - `POST /api/orders/:id/confirm` - 确认收货

3. **订单状态流转**
   ```
   待支付 → 已支付 → 发货中 → 已完成
      ↓        ↓
   已取消   已退款
   ```

### 前端实现

1. **订单管理页面** (`public/orders.html`)
   - 响应式设计，支持PC和手机端
   - 订单状态筛选标签
   - 订单卡片展示
   - 订单详情模态框
   - 物流信息跟踪

2. **用户交互**
   - 从首页用户菜单进入订单管理
   - 支持按状态筛选订单
   - 订单操作按钮根据状态动态显示
   - 实时状态更新和提示

3. **下单流程**
   - 从购物车结算开始
   - 地址选择或添加
   - 订单确认和支付
   - 订单创建成功跳转

## 使用方法

### 1. 访问订单管理

1. 登录平台后，点击右上角用户名
2. 在下拉菜单中选择"我的订单"
3. 或者直接访问 `http://localhost:3000/orders.html`

### 2. 查看订单列表

- **状态筛选**: 点击顶部的状态标签筛选订单
  - 全部订单、待支付、已支付、发货中、已完成、已取消
- **订单信息**: 每个订单显示订单号、时间、状态、商品、金额
- **快速操作**: 根据订单状态显示相应操作按钮

### 3. 查看订单详情

1. 在订单卡片上点击"查看详情"按钮
2. 在详情弹窗中可以看到：
   - 订单基本信息（订单号、时间、状态、支付方式）
   - 商品详细信息（名称、数量、价格、商家）
   - 收货地址信息
   - 物流跟踪信息（如已发货）
   - 订单备注
   - 费用明细

### 4. 下单流程

1. **添加商品**: 在首页将商品加入购物车
2. **结算购物车**: 点击购物车，选择"去结算"
3. **选择地址**: 系统会提示选择收货地址
   - 选择已有地址或添加新地址
4. **确认订单**: 核对商品、地址、金额信息
5. **完成支付**: 确认支付后订单创建成功

### 5. 订单操作

根据订单状态可以进行不同操作：

- **待支付**: 立即支付、取消订单
- **已支付/发货中**: 查看物流
- **已完成**: 确认收货、再次购买
- **已取消/已退款**: 再次购买

## 数据存储

订单信息存储在MongoDB的`orders`集合中，包含以下字段：

```javascript
{
  orderNumber: String,        // 订单号（唯一）
  userId: ObjectId,          // 用户ID
  items: [{                  // 商品列表
    productId: ObjectId,     // 商品ID
    name: String,           // 商品名称
    price: Number,          // 商品价格
    quantity: Number,       // 购买数量
    merchant: String,       // 商家名称
    merchantId: ObjectId,   // 商家ID
    imageUrl: String        // 商品图片
  }],
  total: Number,             // 订单总金额
  status: String,           // 订单状态
  shippingAddress: {        // 收货地址
    name: String,
    phone: String,
    province: String,
    city: String,
    district: String,
    detail: String,
    postalCode: String
  },
  paymentInfo: {             // 支付信息
    method: String,         // 支付方式
    paidAt: Date,          // 支付时间
    transactionId: String  // 交易号
  },
  logistics: {               // 物流信息
    company: String,        // 物流公司
    trackingNumber: String, // 运单号
    shippedAt: Date,       // 发货时间
    deliveredAt: Date,     // 签收时间
    status: String         // 物流状态
  },
  remarks: String,           // 订单备注
  createdAt: Date,           // 创建时间
  updatedAt: Date            // 更新时间
}
```

## 测试功能

### 运行测试脚本

```bash
cd 简易电商平台
node test-orders.js
```

测试脚本会：
1. 创建不同状态的测试订单
2. 测试订单的创建、更新功能
3. 验证订单状态流转
4. 测试订单查询和统计功能

### 手动测试

1. 启动服务器：
   ```bash
   node server.js
   ```

2. 浏览器访问：`http://localhost:3000/login.html`

3. 使用管理员账户登录：
   - 邮箱：`12345@123.com`
   - 密码：`12345`

4. 进行完整的购物和订单管理测试：
   - 添加商品到购物车
   - 选择地址并下单
   - 查看订单状态
   - 进行订单操作

## 订单状态说明

| 状态 | 说明 | 可执行操作 |
|------|------|-----------|
| 待支付 | 订单已创建，等待用户支付 | 立即支付、取消订单 |
| 已支付 | 订单已支付，等待发货 | 查看物流 |
| 发货中 | 商品已发货，正在配送 | 查看物流、确认收货 |
| 已完成 | 用户已确认收货，订单完成 | 再次购买、评价商品 |
| 已取消 | 订单被用户或系统取消 | 再次购买 |
| 已退款 | 订单已退款 | 再次购买 |

## 安全考虑

1. **用户隔离**：目前API返回所有订单，生产环境需要根据当前用户筛选
2. **状态验证**：每个订单操作都有状态验证，防止非法操作
3. **库存管理**：支付成功后自动扣减库存，防止超卖
4. **订单完整性**：下单时验证商品存在性和库存充足性

## 扩展功能建议

1. **支付方式扩展**: 支持支付宝、微信支付等多种支付方式
2. **订单评价**: 用户完成订单后可以评价商品
3. **发票管理**: 支持开具电子发票
4. **退款申请**: 用户可以申请退款
5. **订单提醒**: 订单状态变更时发送短信或邮件通知
6. **批量操作**: 支持批量下单或批量操作订单

## 管理员功能

虽然当前实现主要面向用户，但预留了管理员功能扩展：

1. **订单管理**: 查看所有用户订单
2. **发货操作**: 为已支付订单安排发货
3. **订单统计**: 查看销售数据和统计报表
4. **退款处理**: 处理用户的退款申请

## 故障排除

### 常见问题

1. **订单创建失败**
   - 检查商品库存是否充足
   - 确认收货地址信息完整
   - 验证用户登录状态

2. **支付失败**
   - 检查用户余额是否充足（余额支付）
   - 确认订单状态是否为待支付
   - 查看网络连接是否正常

3. **订单不显示**
   - 检查浏览器控制台错误信息
   - 确认API端点响应正常
   - 刷新页面重新加载

### 调试方法

1. 打开浏览器开发者工具（F12）
2. 查看Network标签页的API请求和响应
3. 查看Console标签页的错误信息
4. 检查服务器日志输出
5. 运行测试脚本验证后端功能

## 性能优化

1. **数据库索引**: 已添加userId、status、createdAt等字段的索引
2. **分页加载**: 订单列表支持分页，避免一次性加载过多数据
3. **缓存机制**: 可以添加Redis缓存热门订单信息
4. **异步处理**: 库存扣减等操作可以异步处理提高性能

## 更新日志

- **v1.0** (2024-11-24): 初始版本，支持完整的订单管理功能
  - 订单创建和状态管理
  - 订单列表和详情查看
  - 地址选择和支付流程
  - 物流跟踪和确认收货
  - 响应式设计支持移动端