<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>商家后台 - MyShop</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand" onclick="window.location.href='/'" style="cursor:pointer;">MyShop 后台</div>
        <div class="nav-actions">
            <div class="nav-item" onclick="window.location.href='/'">
                <i class="fas fa-home"></i> 返回商城
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="card">
            <h2><i class="fas fa-plus-circle"></i> 发布新商品</h2>
            <form id="adminProductForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="prodName">商品名称:</label>
                        <input type="text" id="prodName" required placeholder="例如: 机械键盘">
                    </div>
                    <div class="form-group">
                        <label for="prodPrice">价格 (¥):</label>
                        <input type="number" id="prodPrice" required min="0" step="0.01" placeholder="99.00">
                    </div>
                </div>
                <div class="form-group">
                    <label for="prodDesc">描述:</label>
                    <textarea id="prodDesc" rows="4" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px;" required placeholder="商品详细描述..."></textarea>
                </div>
                <div class="form-group">
                    <label for="prodImage">图片链接:</label>
                    <input type="url" id="prodImage" placeholder="https://example.com/image.jpg">
                </div>
                <div class="form-group">
                    <label for="prodCategory">分类:</label>
                    <select id="prodCategory" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px;">
                        <option value="General">通用</option>
                        <option value="Electronics">电子产品</option>
                        <option value="Clothing">服装</option>
                        <option value="Books">书籍</option>
                        <option value="Home">家居</option>
                        <option value="Beauty">美妆</option>
                    </select>
                </div>
                <button type="submit">上架商品</button>
            </form>
        </div>
        <div class="card">
            <h2><i class="fas fa-users"></i> 用户管理</h2>
            <div id="userList">
                <p>加载中...</p>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // Admin check
        document.addEventListener('DOMContentLoaded', () => {
            const userStr = localStorage.getItem('user');
            if (!userStr) {
                window.location.href = '/login.html';
                return;
            }
            const user = JSON.parse(userStr);
            if (user.role !== 'admin') {
                alert('无权访问');
                window.location.href = '/';
            }
            
            fetchUsers();
        });

        async function fetchUsers() {
            const list = document.getElementById('userList');
            try {
                const res = await fetch('/api/users');
                const users = await res.json();
                
                if (users.length === 0) {
                    list.innerHTML = '<p>暂无用户</p>';
                    return;
                }

                list.innerHTML = users.map(u => `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee;">
                        <div>
                            <strong>${escapeHtml(u.name)}</strong> (${escapeHtml(u.email)})
                            <span style="background:#eee; padding:2px 6px; border-radius:4px; font-size:0.8rem; margin-left:5px;">${u.role}</span>
                        </div>
                        ${u.role !== 'admin' ? `<button onclick="deleteUser('${u._id}')" style="background:#e74c3c; padding:5px 10px; font-size:0.9rem;">删除</button>` : ''}
                    </div>
                `).join('');
            } catch (err) {
                list.innerHTML = '<p style="color:red">加载失败</p>';
            }
        }

        async function deleteUser(id) {
            if (!confirm('确定要删除该用户吗？')) return;
            try {
                const res = await fetch(`/api/users/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    fetchUsers();
                } else {
                    alert('删除失败');
                }
            } catch (err) {
                alert('网络错误');
            }
        }
    </script>
</body>
</html>
